# Supabaseæ•°æ®åŒæ­¥é—®é¢˜ç³»ç»Ÿæ’æŸ¥æŠ¥å‘Š

## ğŸ“Š æ’æŸ¥æ€»ç»“

ç»è¿‡ç³»ç»Ÿæ€§æ’æŸ¥ï¼Œå‘ç°äº†ä»¥ä¸‹å¯èƒ½å¯¼è‡´æ•°æ®æ— æ³•æ­£ç¡®ä¿å­˜åˆ°Supabaseçš„é—®é¢˜ï¼š

`â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`
ä¸»è¦é—®é¢˜é›†ä¸­åœ¨ï¼š1) RLSç­–ç•¥é…ç½®ä¸å½“ 2) ç”¨æˆ·IDåˆå§‹åŒ–æ—¶æœº 3) å­—æ®µæ˜ å°„ä¸ä¸€è‡´ 4) é”™è¯¯å¤„ç†ä¸è¶³ã€‚è¿™äº›é—®é¢˜ç›¸äº’å½±å“ï¼Œå¯¼è‡´æ•°æ®åŒæ­¥é“¾æ¡ä¸­ä»»ä½•ä¸€ç¯å‡ºé”™éƒ½ä¼šé™é»˜å¤±è´¥ã€‚
`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`

## ğŸ”´ å…³é”®é—®é¢˜

### 1. RLSï¼ˆè¡Œçº§å®‰å…¨ï¼‰ç­–ç•¥é—®é¢˜ âš ï¸ ä¸¥é‡

**é—®é¢˜æè¿°**ï¼š
- star_chartsè¡¨å¯èƒ½ç¼ºå°‘INSERTç­–ç•¥
- å¾ˆå¤šè¡¨çš„INSERTç­–ç•¥ä½¿ç”¨`WITH CHECK (true)`ï¼Œè¿™å¯èƒ½å¯¼è‡´æƒé™é—®é¢˜
- ç”¨æˆ·è®¤è¯çŠ¶æ€å¯èƒ½å½±å“RLSç­–ç•¥æ‰§è¡Œ

**å½±å“**ï¼š
- æ•°æ®æ— æ³•å†™å…¥æ•°æ®åº“
- APIè°ƒç”¨è¿”å›403æƒé™é”™è¯¯
- è§¦å‘å™¨å¯èƒ½å› RLSé™åˆ¶æ— æ³•æ‰§è¡Œ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```sql
-- ä¸ºstar_chartsè¡¨æ·»åŠ å®Œæ•´çš„RLSç­–ç•¥
CREATE POLICY "Users can insert own charts" ON star_charts
  FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can view own charts" ON star_charts
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can update own charts" ON star_charts
  FOR UPDATE USING (auth.uid() = user_id);
```

### 2. ç”¨æˆ·IDåˆå§‹åŒ–æ—¶æœºé—®é¢˜ âš ï¸ ä¸¥é‡

**é—®é¢˜æè¿°**ï¼š
- UserDataManagerçš„currentUserIdåˆå§‹åŒ–å»¶è¿Ÿ
- æ–°ç”¨æˆ·æ³¨å†Œåç«‹å³ç”Ÿæˆæ˜Ÿç›˜æ—¶ï¼ŒcurrentUserIdå¯èƒ½ä¸ºnil
- å¯¼è‡´syncToCloudIfNeededæ— æ³•æ‰§è¡Œ

**å½±å“**ï¼š
- æ˜Ÿç›˜æ•°æ®åªä¿å­˜åœ¨æœ¬åœ°
- ç”¨æˆ·ç™»å‡ºåæ•°æ®ä¸¢å¤±

**å·²ä¿®å¤**ï¼šâœ… åœ¨UserDataManagerä¸­å¢åŠ äº†å¤‡ç”¨è·å–ç”¨æˆ·IDçš„é€»è¾‘

### 3. APIè®¤è¯é—®é¢˜ âš ï¸ ä¸­ç­‰

**é—®é¢˜æè¿°**ï¼š
- åŒæ—¶ä½¿ç”¨Bearer tokenå’Œapikeyå¯èƒ½é€ æˆå†²çª
- ç”¨æˆ·tokenå¯èƒ½è¿‡æœŸæˆ–æ— æ•ˆ
- anon keyæƒé™å¯èƒ½ä¸è¶³

**å½±å“**ï¼š
- APIè°ƒç”¨å¤±è´¥
- æ•°æ®æ— æ³•æäº¤åˆ°æœåŠ¡å™¨

**å»ºè®®æ£€æŸ¥ç‚¹**ï¼š
- ç¡®è®¤tokenæ˜¯å¦æœ‰æ•ˆ
- éªŒè¯apikeyæƒé™
- æ£€æŸ¥Supabaseçš„JWTè®¾ç½®

### 4. æ•°æ®å­—æ®µæ˜ å°„é—®é¢˜ âš ï¸ ä¸­ç­‰

**å‘ç°çš„ä¸ä¸€è‡´**ï¼š
- æ•°æ®åº“ä½¿ç”¨`generated_at`ï¼Œä»£ç ä¸­ä½¿ç”¨`generatedAt`
- æ•°æ®åº“ä½¿ç”¨ä¸‹åˆ’çº¿å‘½åï¼ŒSwiftä½¿ç”¨é©¼å³°å‘½å
- JSONåºåˆ—åŒ–æ—¶å¯èƒ½ä¸¢å¤±æ•°æ®

**å½±å“**ï¼š
- æ•°æ®æ— æ³•æ­£ç¡®è§£æ
- æŸäº›å­—æ®µå¯èƒ½ä¸ºnull

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨CodingKeysç¡®ä¿å­—æ®µæ˜ å°„æ­£ç¡®
- æ·»åŠ å­—æ®µéªŒè¯

### 5. é”™è¯¯å¤„ç†ä¸è¶³ âš ï¸ ä¸­ç­‰

**é—®é¢˜æè¿°**ï¼š
- å¾ˆå¤šAPIè°ƒç”¨ä½¿ç”¨`try?`ï¼Œé”™è¯¯è¢«é™é»˜å¿½ç•¥
- ç¼ºå°‘è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- æ²¡æœ‰é‡è¯•æœºåˆ¶

**å½±å“**ï¼š
- é—®é¢˜éš¾ä»¥æ’æŸ¥
- æš‚æ—¶æ€§ç½‘ç»œé—®é¢˜å¯¼è‡´æ•°æ®ä¸¢å¤±

**å·²éƒ¨åˆ†ä¿®å¤**ï¼šâœ… å¢å¼ºäº†é”™è¯¯æ—¥å¿—è¾“å‡º

### 6. ç½‘ç»œè¿æ¥å’Œç¦»çº¿å¤„ç† âœ… è‰¯å¥½

**ç°çŠ¶**ï¼š
- å·²å®ç°OfflineQueueManager
- æœ‰NetworkMonitorç›‘æ§ç½‘ç»œçŠ¶æ€
- ç¦»çº¿æ•°æ®ä¼šç¼“å­˜å¹¶åœ¨ç½‘ç»œæ¢å¤ååŒæ­¥

**æ½œåœ¨é—®é¢˜**ï¼š
- é˜Ÿåˆ—å¯èƒ½å› é”™è¯¯ç´¯ç§¯è¿‡å¤š
- éœ€è¦å®šæœŸæ¸…ç†å¤±è´¥çš„æ“ä½œ

## ğŸŸ¡ æ½œåœ¨é—®é¢˜

### 1. å¹¶å‘é—®é¢˜
- å¤šä¸ªè®¾å¤‡åŒæ—¶ä¿®æ”¹å¯èƒ½é€ æˆå†²çª
- ç¼ºå°‘ä¹è§‚é”æˆ–ç‰ˆæœ¬æ§åˆ¶

### 2. æ•°æ®å¤§å°é™åˆ¶
- Supabaseå¯èƒ½å¯¹å•ä¸ªè¯·æ±‚å¤§å°æœ‰é™åˆ¶
- æ˜Ÿç›˜æ•°æ®å¯èƒ½è¿‡å¤§

### 3. è§¦å‘å™¨æ‰§è¡Œé—®é¢˜
- æ•°æ®åº“è§¦å‘å™¨å¯èƒ½å› æƒé™é—®é¢˜å¤±è´¥
- SECURITY DEFINERè®¾ç½®å¯èƒ½ä¸æ­£ç¡®

## ğŸŸ¢ åšå¾—å¥½çš„åœ°æ–¹

1. **åŒé‡ä¿éšœæœºåˆ¶**ï¼šå®¢æˆ·ç«¯ä¸»åŠ¨åŒæ­¥ + æ•°æ®åº“è§¦å‘å™¨
2. **ç¦»çº¿æ”¯æŒ**ï¼šOfflineQueueManagerå¤„ç†ç¦»çº¿åœºæ™¯
3. **æœ¬åœ°ç¼“å­˜**ï¼šUserDefaultsç¼“å­˜æå‡æ€§èƒ½

## ğŸ“‹ å»ºè®®çš„ä¿®å¤ä¼˜å…ˆçº§

1. **ç«‹å³ä¿®å¤**ï¼š
   - æ·»åŠ star_chartsè¡¨çš„å®Œæ•´RLSç­–ç•¥
   - ç¡®ä¿æ‰€æœ‰è¡¨çš„INSERTç­–ç•¥æ­£ç¡®

2. **å°½å¿«ä¿®å¤**ï¼š
   - å¢å¼ºæ‰€æœ‰APIè°ƒç”¨çš„é”™è¯¯å¤„ç†
   - æ·»åŠ é‡è¯•æœºåˆ¶

3. **è®¡åˆ’æ”¹è¿›**ï¼š
   - å®ç°æ•°æ®ç‰ˆæœ¬æ§åˆ¶
   - æ·»åŠ åŒæ­¥çŠ¶æ€UIåé¦ˆ
   - å®ç°å†²çªè§£å†³æœºåˆ¶

## ğŸ”§ æµ‹è¯•æ£€æŸ¥æ¸…å•

åˆ›å»ºæ–°ç”¨æˆ·å¹¶æµ‹è¯•ä»¥ä¸‹åœºæ™¯ï¼š

- [ ] æ³¨å†Œæ–°ç”¨æˆ· â†’ æ£€æŸ¥profilesè¡¨
- [ ] ç”Ÿæˆæ˜Ÿç›˜ â†’ æ£€æŸ¥star_chartsè¡¨
- [ ] åˆ›å»ºèŠå¤©ä¼šè¯ â†’ æ£€æŸ¥chat_sessionsè¡¨
- [ ] å‘é€æ¶ˆæ¯ â†’ æ£€æŸ¥chat_messagesè¡¨
- [ ] ç¦»çº¿ç”Ÿæˆæ•°æ® â†’ æ¢å¤ç½‘ç»œåæ£€æŸ¥åŒæ­¥
- [ ] åˆ‡æ¢è®¾å¤‡ç™»å½• â†’ éªŒè¯æ•°æ®åŒæ­¥

## ğŸ“ ç›‘æ§å»ºè®®

### SQLç›‘æ§æŸ¥è¯¢
```sql
-- æ£€æŸ¥æœ€è¿‘å¤±è´¥çš„æ“ä½œ
SELECT * FROM audit_logs 
WHERE status = 'failed' 
AND created_at > NOW() - INTERVAL '1 hour';

-- æ£€æŸ¥RLSç­–ç•¥
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual
FROM pg_policies
WHERE schemaname = 'public';

-- æ£€æŸ¥ç”¨æˆ·æ•°æ®å®Œæ•´æ€§
SELECT 
    p.id,
    p.email,
    COUNT(sc.id) as chart_count,
    COUNT(cs.id) as session_count
FROM profiles p
LEFT JOIN star_charts sc ON p.id = sc.user_id
LEFT JOIN chat_sessions cs ON p.id = cs.user_id
GROUP BY p.id, p.email
ORDER BY p.created_at DESC
LIMIT 10;
```

### å®¢æˆ·ç«¯æ—¥å¿—ç›‘æ§ç‚¹
- `ğŸ”„ å¼€å§‹åŒæ­¥æ˜Ÿç›˜åˆ°äº‘ç«¯`
- `âœ… æ˜Ÿç›˜å·²åŒæ­¥åˆ°äº‘ç«¯`
- `âŒ åŒæ­¥åˆ°äº‘ç«¯å¤±è´¥`
- `âŒ ä¿å­˜æ˜Ÿç›˜å¤±è´¥`
- `âš ï¸ æ— æ³•åŒæ­¥æ˜Ÿç›˜`

## çŠ¶æ€
ğŸ“… **æ’æŸ¥æ—¥æœŸ**ï¼š2025-09-13
ğŸ”„ **éœ€è¦æŒç»­ç›‘æ§å’Œæ”¹è¿›**