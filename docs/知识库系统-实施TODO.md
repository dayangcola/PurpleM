# 📋 紫微斗数知识库系统 - 实施TODO清单

## 🎯 项目目标
构建一个PDF知识库系统，让星语AI助手能够检索和引用专业紫微斗数书籍，提供更权威、准确的回答。

## 📅 总体时间线
- **开发周期**: 14个工作日
- **开始日期**: 2025-01-11
- **预计完成**: 2025-01-28
- **测试阶段**: 2025-01-29 - 2025-01-31

---

## 🏗️ Phase 1: 基础架构搭建（2天）
**时间**: Day 1-2 | **负责人**: 开发者 + DBA

### Day 1: Supabase数据库配置
- [ ] **1.1 启用pgvector扩展**
  - 登录Supabase控制台
  - 在SQL编辑器中执行: `CREATE EXTENSION IF NOT EXISTS vector;`
  - 验证安装: `SELECT * FROM pg_extension WHERE extname = 'vector';`

- [ ] **1.2 创建books表**
  ```sql
  -- 执行建表SQL（见技术文档）
  -- 添加必要索引
  -- 设置RLS策略
  ```

- [ ] **1.3 创建knowledge_base表**
  ```sql
  -- 执行建表SQL
  -- 创建向量索引: ivfflat
  -- 创建全文搜索索引: GIN
  ```

### Day 2: API函数与权限
- [ ] **1.4 创建搜索函数**
  - `search_knowledge()`: 向量相似度搜索
  - `hybrid_search()`: 混合搜索（向量+全文）
  - 测试函数性能

- [ ] **1.5 配置存储桶**
  - 创建`pdf-books`存储桶
  - 设置访问策略（私有/公开）
  - 配置CORS（如需要）

- [ ] **1.6 Swift端集成准备**
  - 更新SupabaseManager配置
  - 添加新的数据模型
  - 测试连接

---

## 🔧 Phase 2: PDF处理模块（3天）
**时间**: Day 3-5 | **负责人**: iOS开发者

### Day 3: PDF文本提取
- [ ] **2.1 创建PDFProcessor.swift**
  ```swift
  class PDFProcessor {
      func extractText(from url: URL) -> String
      func extractWithOCR(from url: URL) -> String
      func detectPDFType(url: URL) -> PDFType
  }
  ```

- [ ] **2.2 实现PDFKit文本提取**
  - 处理可搜索PDF
  - 提取页码信息
  - 保留章节结构

- [ ] **2.3 集成Vision Framework OCR**
  - 处理扫描版PDF
  - 图像预处理优化
  - 中文识别优化

### Day 4: 文本分块算法
- [ ] **2.4 创建TextChunker.swift**
  ```swift
  class TextChunker {
      func chunkBySemantics(text: String) -> [TextChunk]
      func chunkBySize(text: String, maxSize: Int) -> [TextChunk]
      func detectChapters(text: String) -> [Chapter]
  }
  ```

- [ ] **2.5 实现智能分块**
  - 章节检测（正则表达式）
  - 段落保持完整性
  - 重叠窗口处理

- [ ] **2.6 专业术语处理**
  - 建立紫微斗数词典
  - 避免术语被分割
  - 保留上下文关系

### Day 5: 批处理逻辑
- [ ] **2.7 批量处理管理器**
  - 队列管理
  - 进度跟踪
  - 错误重试机制

- [ ] **2.8 性能优化**
  - 内存管理
  - 并发处理
  - 大文件分片

---

## 🧮 Phase 3: 向量化与存储（2天）
**时间**: Day 6-7 | **负责人**: 后端开发者

### Day 6: OpenAI集成
- [ ] **3.1 创建EmbeddingService.swift**
  ```swift
  class EmbeddingService {
      func generateEmbedding(text: String) async -> [Float]
      func batchGenerate(texts: [String]) async -> [[Float]]
  }
  ```

- [ ] **3.2 OpenAI API集成**
  - 配置API密钥
  - 实现embedding调用
  - 处理速率限制

- [ ] **3.3 批量处理优化**
  - 20个文本/批次
  - 自动重试机制
  - 成本监控

### Day 7: 数据上传流程
- [ ] **3.4 创建KnowledgeUploader.swift**
  - 协调整个上传流程
  - 事务管理
  - 进度回调

- [ ] **3.5 数据验证**
  - 向量维度检查
  - 内容去重
  - 元数据完整性

- [ ] **3.6 错误处理**
  - 部分失败恢复
  - 日志记录
  - 用户反馈

---

## 🔍 Phase 4: 检索系统（2天）
**时间**: Day 8-9 | **负责人**: 算法工程师

### Day 8: 检索实现
- [ ] **4.1 创建KnowledgeRetriever.swift**
  ```swift
  class KnowledgeRetriever {
      func vectorSearch(query: String, limit: Int) async -> [SearchResult]
      func hybridSearch(query: String) async -> [SearchResult]
      func getContext(for result: SearchResult) -> String
  }
  ```

- [ ] **4.2 向量检索**
  - 查询向量化
  - 余弦相似度计算
  - 阈值过滤（>0.7）

- [ ] **4.3 混合搜索**
  - 向量权重: 70%
  - 全文权重: 30%
  - 结果融合算法

### Day 9: 缓存与优化
- [ ] **4.4 创建KnowledgeCache.swift**
  - LRU缓存实现
  - 15分钟过期策略
  - 内存管理

- [ ] **4.5 性能优化**
  - 索引优化（HNSW vs IVFFlat）
  - 查询优化
  - 批量预取

- [ ] **4.6 相关性改进**
  - 重排序算法
  - 上下文扩展
  - 同义词处理

---

## 🎨 Phase 5: UI与集成（3天）
**时间**: Day 10-12 | **负责人**: iOS开发者

### Day 10: 书籍管理界面
- [ ] **5.1 创建BookManagementView.swift**
  - 书籍列表展示
  - 上传入口
  - 删除功能

- [ ] **5.2 上传界面**
  - 文件选择器
  - 进度条展示
  - 错误提示

- [ ] **5.3 书籍详情**
  - 元数据展示
  - 处理状态
  - 知识条目统计

### Day 11: AI对话集成
- [ ] **5.4 修改EnhancedAIService**
  - 添加知识检索调用
  - 构建增强提示词
  - 引用格式化

- [ ] **5.5 引用标注UI**
  - 上标数字标注
  - 底部参考列表
  - 点击查看原文

- [ ] **5.6 相关性展示**
  - 相似度分数
  - 来源章节
  - 置信度指示

### Day 12: 设置与管理
- [ ] **5.7 知识库设置**
  - 启用/禁用开关
  - 检索数量设置
  - 相似度阈值调整

- [ ] **5.8 权限管理**
  - 私有/公开切换
  - 分享功能
  - 访问控制

---

## 🧪 Phase 6: 测试与优化（2天）
**时间**: Day 13-14 | **负责人**: QA + 全体

### Day 13: 功能测试
- [ ] **6.1 单元测试**
  - PDF处理测试
  - 分块算法测试
  - 检索准确性测试

- [ ] **6.2 集成测试**
  - 端到端流程
  - 并发上传
  - 大文件处理

- [ ] **6.3 UI测试**
  - 交互流畅性
  - 错误场景
  - 响应时间

### Day 14: 优化与文档
- [ ] **6.4 性能优化**
  - 瓶颈分析
  - 查询优化
  - 缓存调优

- [ ] **6.5 用户体验优化**
  - 加载动画
  - 错误提示优化
  - 操作引导

- [ ] **6.6 文档完善**
  - 使用说明
  - API文档
  - 故障排查指南

---

## 📊 测试书籍清单
准备以下PDF进行测试：

1. **《紫微斗数全书》** - 200页
   - 测试重点：基础文本提取
   - 预期时间：3-5分钟

2. **《紫微斗数精成》** - 150页
   - 测试重点：章节识别
   - 预期时间：2-4分钟

3. **《十八飞星策天紫微斗数》** - 300页
   - 测试重点：大文件处理
   - 预期时间：5-8分钟

---

## 🚨 风险与缓解措施

### 风险1: OCR识别率低
- **缓解**: 预处理图像增强，提供手动校正选项

### 风险2: 向量生成成本高
- **缓解**: 实施缓存机制，批量处理优化

### 风险3: 检索相关性差
- **缓解**: 混合搜索策略，持续调优阈值

### 风险4: 响应时间过长
- **缓解**: 异步处理，预加载常用内容

---

## 📈 成功指标

1. **处理性能**
   - ✅ 100页PDF < 5分钟完成
   - ✅ OCR准确率 > 95%

2. **检索质量**
   - ✅ 相关内容召回率 > 80%
   - ✅ 响应时间 < 500ms

3. **用户体验**
   - ✅ 操作流畅无卡顿
   - ✅ 错误处理完善

---

## 🔄 每日同步机制

### 每日站会（10分钟）
- 昨日完成
- 今日计划
- 遇到问题

### 进度更新
- 每天18:00更新TODO状态
- 遇到阻塞立即沟通
- 关键节点演示

---

## 🎯 里程碑

- **M1 (Day 2)**: 数据库就绪 ✓
- **M2 (Day 5)**: PDF处理完成 ✓
- **M3 (Day 7)**: 向量化就绪 ✓
- **M4 (Day 9)**: 检索系统完成 ✓
- **M5 (Day 12)**: UI集成完成 ✓
- **M6 (Day 14)**: 测试通过，系统上线 ✓

---

## 💡 备注

1. **优先级调整**: 如时间紧张，可先实现基础功能，OCR等高级功能后续迭代
2. **并行开发**: PDF处理和数据库可并行进行
3. **测试先行**: 每个模块完成立即测试，不要累积到最后
4. **文档同步**: 开发过程中同步更新文档

---

*最后更新: 2025-01-11*
*负责人: 星语AI团队*