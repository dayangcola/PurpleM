# 📚 紫微斗数知识库系统 - 技术设计文档

## 一、系统概述

### 1.1 项目背景
星语助手需要参考专业的紫微斗数书籍来提供更准确、更权威的回答。通过构建PDF知识库系统，让AI能够检索和引用相关资料，提升回答的专业性和可信度。

### 1.2 核心功能
- **PDF上传与解析**：支持上传紫微斗数相关PDF书籍
- **智能检索**：基于语义相似度检索相关内容
- **精准引用**：AI回答时标注参考来源
- **知识管理**：支持增删改查知识库内容

### 1.3 技术栈
- **前端**：SwiftUI + PDFKit
- **后端**：Supabase + PostgreSQL
- **向量数据库**：pgvector
- **AI服务**：OpenAI Embeddings API
- **文字识别**：Vision Framework (iOS OCR)

## 二、系统架构

### 2.1 数据流程
```
PDF上传 → 文本提取 → 智能分块 → 向量化 → 存储 → 检索 → AI引用
```

### 2.2 核心组件

#### 前端组件
- `PDFProcessor.swift`：PDF文本提取与OCR
- `TextChunker.swift`：文本智能分块
- `KnowledgeUploader.swift`：知识上传管理
- `BookManagementView.swift`：书籍管理界面

#### 后端组件
- `EmbeddingService.swift`：向量生成服务
- `KnowledgeRetriever.swift`：知识检索服务
- `KnowledgeCache.swift`：缓存管理

#### 数据库结构
- `books`：书籍元数据表
- `knowledge_base`：知识内容表（含向量）
- `search_knowledge()`：相似度搜索函数
- `hybrid_search()`：混合搜索函数

## 三、详细设计

### 3.1 数据库设计

```sql
-- 启用pgvector扩展
CREATE EXTENSION IF NOT EXISTS vector;

-- 书籍元数据表
CREATE TABLE books (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title TEXT NOT NULL,
    author TEXT,
    category TEXT,              -- 分类：紫微斗数、四柱八字、风水等
    description TEXT,
    file_url TEXT,             -- 原始PDF存储URL
    file_size INTEGER,         -- 文件大小（字节）
    total_pages INTEGER,       -- 总页数
    processing_status TEXT,    -- pending/processing/completed/failed
    upload_by UUID REFERENCES users(id),
    is_public BOOLEAN DEFAULT false,  -- 是否公开
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 知识库内容表
CREATE TABLE knowledge_base (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    book_id UUID REFERENCES books(id) ON DELETE CASCADE,
    book_title TEXT NOT NULL,
    chapter TEXT,              -- 章节标题
    section TEXT,              -- 小节标题
    page_number INTEGER,       -- 页码
    content TEXT NOT NULL,     -- 文本内容
    content_length INTEGER,    -- 内容长度
    embedding vector(1536),    -- OpenAI embedding向量
    metadata JSONB,           -- 额外元数据
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    -- 全文搜索
    search_vector tsvector GENERATED ALWAYS AS (
        setweight(to_tsvector('chinese', coalesce(chapter, '')), 'A') ||
        setweight(to_tsvector('chinese', coalesce(section, '')), 'B') ||
        setweight(to_tsvector('chinese', content), 'C')
    ) STORED
);

-- 创建索引
CREATE INDEX idx_knowledge_embedding ON knowledge_base 
USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);

CREATE INDEX idx_knowledge_search ON knowledge_base USING GIN (search_vector);
CREATE INDEX idx_knowledge_book ON knowledge_base(book_id);
```

### 3.2 PDF处理流程

#### 3.2.1 文本提取策略
1. **可搜索PDF**：直接提取文本
2. **扫描版PDF**：使用OCR识别
3. **混合型PDF**：优先直接提取，失败则OCR

#### 3.2.2 分块策略
- **基础规则**：
  - 最大块大小：1000字符
  - 重叠大小：100字符
  - 保持段落完整性

- **智能分割**：
  - 优先按章节分割
  - 其次按段落分割
  - 最后按句子分割

#### 3.2.3 向量化处理
- **模型**：OpenAI text-embedding-ada-002
- **维度**：1536
- **批处理**：每批20个文本块
- **速率限制**：1秒/批次

### 3.3 检索策略

#### 3.3.1 纯向量搜索
```sql
-- 余弦相似度搜索
SELECT content, 1 - (embedding <=> query_embedding) as similarity
FROM knowledge_base
WHERE 1 - (embedding <=> query_embedding) > 0.7
ORDER BY embedding <=> query_embedding
LIMIT 5;
```

#### 3.3.2 混合搜索（推荐）
- **向量搜索权重**：70%
- **全文搜索权重**：30%
- **综合评分**：vector_score * 0.7 + text_score * 0.3

#### 3.3.3 上下文扩展
检索到相关内容后，获取前后文：
- 前文：50字符
- 后文：50字符

### 3.4 AI集成方案

#### 3.4.1 增强提示词模板
```
# 基础角色设定
[原有的星语人设]

# 知识库参考
【参考资料】
来源：《紫微斗数全书》第三章
内容：[检索到的相关内容]
相关度：85%

来源：《紫微斗数精成》第五章  
内容：[检索到的相关内容]
相关度：78%

# 回答要求
1. 基于参考资料提供准确回答
2. 如引用资料请标注来源
3. 资料不足时说明并提供一般性建议
```

#### 3.4.2 引用格式
```
根据《紫微斗数全书》记载，紫微星..."[1]

参考资料：
[1] 《紫微斗数全书》第三章，页码 45-46
```

## 四、实施计划

### 4.1 开发阶段

#### Phase 1：基础架构（2天）
- [ ] Supabase数据库搭建
- [ ] pgvector配置
- [ ] 基础表结构创建
- [ ] API函数编写

#### Phase 2：PDF处理（3天）
- [ ] PDF文本提取
- [ ] OCR集成
- [ ] 文本分块算法
- [ ] 批量处理逻辑

#### Phase 3：向量化与存储（2天）
- [ ] OpenAI API集成
- [ ] 向量生成服务
- [ ] 数据上传流程
- [ ] 错误处理

#### Phase 4：检索系统（2天）
- [ ] 向量检索实现
- [ ] 混合搜索优化
- [ ] 缓存机制
- [ ] 性能优化

#### Phase 5：UI与集成（3天）
- [ ] 书籍管理界面
- [ ] 上传进度显示
- [ ] AI对话集成
- [ ] 引用标注

#### Phase 6：测试与优化（2天）
- [ ] 功能测试
- [ ] 性能测试
- [ ] 用户体验优化
- [ ] 文档完善

### 4.2 MVP功能列表

**必须功能**：
- ✅ PDF上传（单本）
- ✅ 文本提取
- ✅ 向量检索
- ✅ AI引用

**可选功能**：
- ⭕ OCR识别
- ⭕ 批量上传
- ⭕ 知识编辑
- ⭕ 公共知识库

### 4.3 测试书籍
建议先用以下书籍测试：
1. 《紫微斗数全书》（基础教材）
2. 《紫微斗数精成》（进阶内容）
3. 《十八飞星策天紫微斗数》（专业参考）

## 五、性能指标

### 5.1 处理性能
- PDF处理：100页 < 5分钟
- 向量生成：1000块 < 10分钟
- 检索响应：< 500ms
- 缓存命中率：> 60%

### 5.2 存储估算
- 单本书（200页）：
  - 原文：~500KB
  - 向量：~5MB
  - 索引：~1MB
- 100本书总计：~650MB

### 5.3 成本估算
- Supabase：免费层足够（< 500MB）
- OpenAI Embedding：~$0.1/书
- 月度成本：< $10（100本书规模）

## 六、安全与隐私

### 6.1 权限控制
- **私有知识库**：仅上传者可见
- **共享知识库**：登录用户可见
- **公共知识库**：所有人可见

### 6.2 版权考虑
- 仅供个人学习使用
- 不存储完整原文
- 分块存储避免直接复制

### 6.3 数据安全
- PDF原文加密存储
- 向量数据脱敏处理
- 定期备份

## 七、扩展规划

### 7.1 高级功能
- **知识图谱**：构建概念关系网络
- **交叉引用**：多书籍综合分析
- **版本对比**：不同版本差异分析
- **笔记系统**：用户个人笔记

### 7.2 优化方向
- **更好的分块**：基于语义的智能分块
- **多语言支持**：支持繁体、英文资料
- **实时更新**：增量知识更新
- **协同编辑**：多人共建知识库

## 八、技术挑战与解决方案

### 8.1 挑战
1. **中文分词**：紫微斗数专业术语
2. **OCR准确率**：古籍扫描件质量
3. **语义理解**：文言文内容
4. **检索相关性**：专业术语匹配

### 8.2 解决方案
1. **自定义词典**：建立专业术语库
2. **预处理优化**：图像增强提升OCR
3. **双语标注**：文言文+白话文
4. **混合检索**：向量+关键词+同义词

## 九、参考资源

### 9.1 技术文档
- [Supabase Vector](https://supabase.com/docs/guides/ai/vector-columns)
- [pgvector Documentation](https://github.com/pgvector/pgvector)
- [OpenAI Embeddings](https://platform.openai.com/docs/guides/embeddings)

### 9.2 示例代码
- [LangChain PDF Loader](https://python.langchain.com/docs/modules/data_connection/document_loaders/pdf)
- [Supabase Vector Search](https://github.com/supabase-community/supabase-vector-search)

### 9.3 最佳实践
- [RAG Best Practices](https://www.pinecone.io/learn/retrieval-augmented-generation/)
- [Chunking Strategies](https://www.pinecone.io/learn/chunking-strategies/)

---

*文档版本：1.0*  
*更新日期：2024-01-11*  
*作者：星语AI团队*