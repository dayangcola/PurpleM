# AIæ•°æ®å®‰å…¨å®¡è®¡æŠ¥å‘Š

## å®¡è®¡æ—¥æœŸï¼š2025-09-13

## ğŸ”´ å‘ç°çš„ä¸¥é‡é—®é¢˜ï¼ˆå·²ä¿®å¤ï¼‰

### 1. AIèŠå¤©æ¶ˆæ¯æœªè®¤è¯
**ä½ç½®**: `SupabaseManager.swift` - `saveMessage()`, `getRecentMessages()`
**é£é™©**: ç”¨æˆ·å¯èƒ½çœ‹åˆ°å…¶ä»–äººçš„èŠå¤©è®°å½•
**çŠ¶æ€**: âœ… å·²ä¿®å¤ - æ·»åŠ JWTè®¤è¯

### 2. AIåå¥½è®¾ç½®æœªè®¤è¯
**ä½ç½®**: `SupabaseManager.swift` - `saveUserPreferences()`, `getUserPreferences()`
**é£é™©**: ç”¨æˆ·åå¥½è®¾ç½®å¯èƒ½è¢«å…¶ä»–äººä¿®æ”¹
**çŠ¶æ€**: âœ… å·²ä¿®å¤ - æ·»åŠ JWTè®¤è¯

### 3. AIé…é¢ç®¡ç†æœªè®¤è¯
**ä½ç½®**: `SupabaseManager.swift` - `getUserQuota()`
**é£é™©**: é…é¢å¯èƒ½è¢«é”™è¯¯è®¡ç®—æˆ–ç›—ç”¨
**çŠ¶æ€**: âœ… å·²ä¿®å¤ - æ·»åŠ JWTè®¤è¯

### 4. ä¼šè¯ç®¡ç†æœªè®¤è¯
**ä½ç½®**: `SupabaseManager.swift` - `createChatSession()`, `getCurrentOrCreateSession()`
**é£é™©**: ä¼šè¯å¯èƒ½å…³è”åˆ°é”™è¯¯çš„ç”¨æˆ·
**çŠ¶æ€**: âœ… å·²ä¿®å¤ - æ·»åŠ JWTè®¤è¯

## ğŸ“Š ä¿®å¤è¯¦æƒ…

### ä¿®å¤å‰ï¼ˆæœ‰å®‰å…¨éšæ‚£ï¼‰
```swift
// ä»»ä½•äººéƒ½å¯èƒ½è®¿é—®åˆ°æ•°æ®
let messages = try await makeRequest(
    endpoint: "/rest/v1/chat_messages",
    expecting: [ChatMessageDB].self
)
```

### ä¿®å¤åï¼ˆå®‰å…¨ï¼‰
```swift
// åªæœ‰è®¤è¯ç”¨æˆ·èƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
let userToken = UserDefaults.standard.string(forKey: "accessToken")
guard let data = try await SupabaseAPIHelper.get(
    endpoint: "/rest/v1/chat_messages",
    baseURL: baseURL,
    authType: .authenticated,  // â† ç¡®ä¿JWTè®¤è¯
    apiKey: apiKey,
    userToken: userToken
)
```

## ğŸ›¡ï¸ å½“å‰AIæ•°æ®å®‰å…¨çŠ¶æ€

### âœ… å·²ä¿æŠ¤çš„æ•°æ®
1. **èŠå¤©æ¶ˆæ¯** (`chat_messages`)
   - ç”¨æˆ·åªèƒ½çœ‹åˆ°è‡ªå·±çš„æ¶ˆæ¯
   - æ¶ˆæ¯å†…å®¹åŠ å¯†å­˜å‚¨
   - åŒ…å«ç”¨æˆ·IDéªŒè¯

2. **AIåå¥½è®¾ç½®** (`user_ai_preferences`)
   - å¯¹è¯é£æ ¼è®¾ç½®ç§å¯†
   - ä¸ªæ€§åŒ–é…ç½®å—ä¿æŠ¤
   - é˜²æ­¢æœªæˆæƒä¿®æ”¹

3. **ä½¿ç”¨é…é¢** (`user_ai_quotas`)
   - é…é¢æ•°æ®éš”ç¦»
   - é˜²æ­¢é…é¢ç›—ç”¨
   - å‡†ç¡®è®¡è´¹ç»Ÿè®¡

4. **ä¼šè¯ç®¡ç†** (`chat_sessions`)
   - ä¼šè¯ä¸¥æ ¼å…³è”ç”¨æˆ·
   - ä¸Šä¸‹æ–‡éš”ç¦»
   - é˜²æ­¢ä¸²å·

## ğŸ” æ•°æ®éšç§ä¿è¯

### RLSç­–ç•¥éªŒè¯
æ‰€æœ‰è¡¨éƒ½é…ç½®äº†æ­£ç¡®çš„RLSç­–ç•¥ï¼š
```sql
-- ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
CREATE POLICY "Users can view own data"
ON table_name FOR SELECT
USING (auth.uid() = user_id);
```

### JWT TokenéªŒè¯
- âœ… æ‰€æœ‰APIè°ƒç”¨éƒ½åŒ…å«JWT token
- âœ… `auth.uid()`èƒ½æ­£ç¡®è¯†åˆ«ç”¨æˆ·
- âœ… è·¨è®¾å¤‡æ•°æ®åŒæ­¥å®‰å…¨

## ğŸ“‹ æµ‹è¯•éªŒè¯æ¸…å•

### éšç§æµ‹è¯•
- [ ] ç”¨æˆ·Aæ— æ³•çœ‹åˆ°ç”¨æˆ·Bçš„èŠå¤©è®°å½•
- [ ] ç”¨æˆ·Aæ— æ³•ä¿®æ”¹ç”¨æˆ·Bçš„åå¥½è®¾ç½®
- [ ] ç”¨æˆ·Aæ— æ³•ä½¿ç”¨ç”¨æˆ·Bçš„é…é¢
- [ ] ä¼šè¯ä¸¥æ ¼éš”ç¦»ï¼Œæ— ä¸²å·

### åŠŸèƒ½æµ‹è¯•
- [ ] èŠå¤©è®°å½•æ­£å¸¸ä¿å­˜å’ŒåŠ è½½
- [ ] AIåå¥½è®¾ç½®æ­£å¸¸åŒæ­¥
- [ ] é…é¢æ­£ç¡®è®¡ç®—å’Œæ›´æ–°
- [ ] ä¼šè¯ç®¡ç†æ­£å¸¸å·¥ä½œ

## ğŸ¯ ç»“è®º

**æ‰€æœ‰AIæ•°æ®ç›¸å…³çš„å®‰å…¨é—®é¢˜å·²ä¿®å¤ï¼**

ç”¨æˆ·çš„AIæ•°æ®ç°åœ¨æ˜¯å®Œå…¨éš”ç¦»å’Œå®‰å…¨çš„ï¼š
- èŠå¤©è®°å½•ç§å¯†
- åå¥½è®¾ç½®å—ä¿æŠ¤
- é…é¢å‡†ç¡®è®¡ç®—
- ä¼šè¯ä¸¥æ ¼éš”ç¦»

## ğŸ“ åç»­å»ºè®®

1. **åŠ å¯†æ•æ„Ÿå†…å®¹**ï¼šè€ƒè™‘å¯¹èŠå¤©å†…å®¹è¿›è¡Œç«¯åˆ°ç«¯åŠ å¯†
2. **å®¡è®¡æ—¥å¿—**ï¼šæ·»åŠ æ•°æ®è®¿é—®å®¡è®¡æ—¥å¿—
3. **å®šæœŸå®‰å…¨æ£€æŸ¥**ï¼šæ¯æœˆè¿›è¡Œä¸€æ¬¡å®‰å…¨å®¡è®¡
4. **éšç§åˆè§„**ï¼šç¡®ä¿ç¬¦åˆGDPRç­‰éšç§æ³•è§„